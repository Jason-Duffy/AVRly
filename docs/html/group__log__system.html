<!-- HTML header for doxygen 1.9.3-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AVRly - AVR Development Resources: Log System</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">AVRly - AVR Development Resources
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('group__log__system.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#files">Files</a>  </div>
  <div class="headertitle"><div class="title">Log System<div class="ingroups"><a class="el" href="group__debug__tools.html">Debug Tools</a></div></div></div>
</div><!--header-->
<div class="contents">

<p>Logging subsystem to print debug messages over USART to PC.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="files" name="files"></a>
Files</h2></td></tr>
<tr class="memitem:debug-tools_2log-system_2example_2log__system_8c"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug-tools_2log-system_2example_2log__system_8c.html">log_system.c</a></td></tr>
<tr class="memdesc:debug-tools_2log-system_2example_2log__system_8c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Driver file providing logging functionality over USART, to print debug messages and values to a teminal program on your PC. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:debug-tools_2log-system_2example_2log__system_8h"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug-tools_2log-system_2example_2log__system_8h.html">log_system.h</a></td></tr>
<tr class="memdesc:debug-tools_2log-system_2example_2log__system_8h"><td class="mdescLeft">&#160;</td><td class="mdescRight">Driver file providing logging functionality over USART, to print debug messages and values to a teminal program on your PC. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:modules_2debug-tools_2log-system_2example_2main_8c"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="modules_2debug-tools_2log-system_2example_2main_8c.html">main.c</a></td></tr>
<tr class="memdesc:modules_2debug-tools_2log-system_2example_2main_8c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Main routine for log_system example application. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:debug-tools_2log-system_2example_2usart_8c"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug-tools_2log-system_2example_2usart_8c.html">usart.c</a></td></tr>
<tr class="memdesc:debug-tools_2log-system_2example_2usart_8c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Driver file providing core USART communication between the target MCU and your PC. This file was adapted from Elliot Williams' Github repo hexagon5un. (link in the see also section below). <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:debug-tools_2log-system_2example_2usart_8h"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug-tools_2log-system_2example_2usart_8h.html">usart.h</a></td></tr>
<tr class="memdesc:debug-tools_2log-system_2example_2usart_8h"><td class="mdescLeft">&#160;</td><td class="mdescRight">Driver file providing core USART communication between the target MCU and your PC. This file was adapted from Elliot Williams' Github repo hexagon5un (link in the see also section below). NOTE: This driver does involve blocking waits, this may be improved on in a later version. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p >Logging subsystem to print debug messages over USART to PC. </p>
<dl class="section see"><dt>See also</dt><dd>The files can be downloaded from the repo at: <a href="https://github.com/Jason-Duffy/AVRly/tree/main/content/modules/debug-tools/log-system/example">https://github.com/Jason-Duffy/AVRly/tree/main/content/modules/debug-tools/log-system/example</a> </dd></dl>


<h3><a id="md_content_modules_debug_tools_log_system_README" name="md_content_modules_debug_tools_log_system_README"></a>README</h3><div class="textblock"><h2><a class="anchor" id="autotoc_md92"></a>
Introduction</h2>
<p >In some cases, taking the time to build yourself a well defined and crafted tool can save you an immense amount time in the future. In my opinion, a logging subsystem is one of those cases. It can help to root out tricky bugs by telling you when each function is being entered and exited, and the state of variables along the way.</p>
<p >This tool implements the USART driver, and is a good example of the <a href="https://en.wikipedia.org/wiki/Facade_pattern" target="_blank">facade pattern</a> in practice. Note how neither the user nor the log_system module need to know anything about how the message is sent over USART in order to send the messages. If you <b>would</b> like to know how the USART driver works, see the module <a href="https://jason-duffy.github.io/AVRly/html/group__usart.html" target="_blank">here</a>.</p>
<h2><a class="anchor" id="autotoc_md93"></a>
Interface</h2>
<p >In this example, we will be using a [USB to serial converter][USB_SERIAL_CONVERTER_URL] to communicate between a PC and the AVR MCU. The connections should be made as shown in the schematic below. Note that the RX and TX (Receive and Transmit) pins are crossed over - RX on the host MCU is connected to TX on the adapter and vice versa.</p>
<div class="image">
<img src="USB_serial_adapter_schem.png" alt=""/>
<div class="caption">
USB to Serial Adapter Schematic</div></div>
   <p >If you are using the AVRly dev kit, then the side of the adapter PCB the components are mounted on should be facing towards the MCU.</p>
<p >Connect the adapter to the PC using a USB cable, open up CoolTerm, go to Options &gt; Serial Port Options &gt; Port and select the one beginning with "usbserial", then set the baud rate to 9600.</p>
<div class="image">
<img src="CoolTerm_Options_1.png" alt=""/>
<div class="caption">
Initial CoolTerm Setup Options</div></div>
   <p >Next, go to "Receive" on the left side of the options menu. Check "Add timestamps to received data" and select "Time + Milliseconds" as the type, then check "Wait for line ending", then press OK.</p>
<div class="image">
<img src="CoolTerm_receive_settings.png" alt=""/>
<div class="caption">
Secondary CoolTerm Setup Options</div></div>
   <p >Press the Connect button, and the new connection status should be displayed on the bottom left of the screen. If it's connected, you're ready to start communication! If not, check your connections and repeat the steps above.</p>
<h2><a class="anchor" id="autotoc_md94"></a>
Example Application</h2>
<p >In each file you want to be able to send log messages from, you'll need to #include log_system.h, and instantiate a config object, as shown below.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;log_system.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * Instantiation of log_system config object. </span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a class="code hl_struct" href="structlog__system__config__t.html">log_system_config_t</a> <a class="code hl_variable" href="modules_2debug-tools_2log-system_2example_2main_8c.html#aa128c6f24c0415caf71f2624c49be464">main_log</a> =</div>
<div class="line">{</div>
<div class="line">  .p_system_tag = <span class="stringliteral">&quot;Main&quot;</span>,   <span class="comment">// Nametag string for the module - must be unique.</span></div>
<div class="line">  .file_log_level = DEBUG,  <span class="comment">// Maximum logging output desired for the file. </span></div>
<div class="line">};</div>
<div class="ttc" id="amodules_2debug-tools_2log-system_2example_2main_8c_html_aa128c6f24c0415caf71f2624c49be464"><div class="ttname"><a href="modules_2debug-tools_2log-system_2example_2main_8c.html#aa128c6f24c0415caf71f2624c49be464">main_log</a></div><div class="ttdeci">log_system_config_t main_log</div><div class="ttdoc">Instantiation of log_system config object.</div><div class="ttdef"><b>Definition:</b> <a href="modules_2debug-tools_2log-system_2example_2main_8c_source.html#l00042">main.c:42</a></div></div>
<div class="ttc" id="astructlog__system__config__t_html"><div class="ttname"><a href="structlog__system__config__t.html">log_system_config_t</a></div><div class="ttdoc">Config object, to be instantiated in each file the log system is to be used, then pass it's address i...</div><div class="ttdef"><b>Definition:</b> <a href="debug-tools_2log-system_2example_2log__system_8h_source.html#l00058">log_system.h:59</a></div></div>
</div><!-- fragment --><p >p_system_tag is nametag for the file or module, stored as a string. Give it a unique name, and this will be printed to the terminal program so you know where the message came from.</p>
<p >file_log_level is used to set the maximum desired logging output level for that particular file. Acceptable values listed from lowest level to highest are shown in the enumeration log_type_t included with log_system.h</p>
<div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * Enumerated constants for the type of message to be logged.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div>
<div class="line">{</div>
<div class="line">    NONE,</div>
<div class="line">    ERROR,</div>
<div class="line">    WARNING,</div>
<div class="line">    INFO,</div>
<div class="line">    DEBUG,</div>
<div class="line">    VERBOSE_DEBUG</div>
<div class="line">} <a class="code hl_enumeration" href="debug-tools_2log-system_2example_2log__system_8h.html#af8da7b968cb9659aef1acb8c79ff7250">log_type_t</a>;</div>
<div class="ttc" id="adebug-tools_2log-system_2example_2log__system_8h_html_af8da7b968cb9659aef1acb8c79ff7250"><div class="ttname"><a href="debug-tools_2log-system_2example_2log__system_8h.html#af8da7b968cb9659aef1acb8c79ff7250">log_type_t</a></div><div class="ttdeci">log_type_t</div><div class="ttdoc">Enumerated constants for the type of message to be logged.</div><div class="ttdef"><b>Definition:</b> <a href="debug-tools_2log-system_2example_2log__system_8h_source.html#l00039">log_system.h:40</a></div></div>
</div><!-- fragment --><p >Next, in the <a class="el" href="getting-started_2source_2main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4" title="Main routine to be executed on the MCU.">main()</a> routine of main.c, you'll need to call the initialisation routine <a class="el" href="data-converters_2mcp48x2__dac_2example_2log__system_8c.html#a66cb0502754421251d61e6c64b499398" title="Initialisation routine - call this function once at startup before using other functions.">init_log_system()</a> to set up the log system and it's dependancies ready for use.</p>
<div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * Main routine for example application. </span></div>
<div class="line"><span class="comment"> */</span> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="getting-started_2source_2main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Setup</span></div>
<div class="line">    <a class="code hl_function" href="data-converters_2mcp48x2__dac_2example_2log__system_8c.html#a66cb0502754421251d61e6c64b499398">init_log_system</a>();</div>
<div class="line">    log_message(&amp;<a class="code hl_variable" href="modules_2debug-tools_2log-system_2example_2main_8c.html#aa128c6f24c0415caf71f2624c49be464">main_log</a>, INFO, <span class="stringliteral">&quot;Hello, World!&quot;</span>);</div>
<div class="ttc" id="adata-converters_2mcp48x2__dac_2example_2log__system_8c_html_a66cb0502754421251d61e6c64b499398"><div class="ttname"><a href="data-converters_2mcp48x2__dac_2example_2log__system_8c.html#a66cb0502754421251d61e6c64b499398">init_log_system</a></div><div class="ttdeci">void init_log_system(void)</div><div class="ttdoc">Initialisation routine - call this function once at startup before using other functions.</div><div class="ttdef"><b>Definition:</b> <a href="data-converters_2mcp48x2__dac_2example_2log__system_8c_source.html#l00046">log_system.c:46</a></div></div>
<div class="ttc" id="agetting-started_2source_2main_8c_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="getting-started_2source_2main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdoc">Main routine to be executed on the MCU.</div><div class="ttdef"><b>Definition:</b> <a href="getting-started_2source_2main_8c_source.html#l00045">main.c:45</a></div></div>
</div><!-- fragment --><p >Once that's done, you can start calling the log functions - just pass the address of the <a class="el" href="structlog__system__config__t.html" title="Config object, to be instantiated in each file the log system is to be used, then pass it&#39;s address i...">log_system_config_t</a> object in as the first parameter, followed by the log level of the message (again taken from log_type_t), then your message as a string literal, and then sometimes the value to be logged, depending on the function called.</p>
<div class="fragment"><div class="line">log_message_with_bin_val(&amp;<a class="code hl_variable" href="modules_2debug-tools_2log-system_2example_2main_8c.html#aa128c6f24c0415caf71f2624c49be464">main_log</a>, DEBUG,</div>
<div class="line">                <span class="stringliteral">&quot;The binary format value of example_variable is: &quot;</span>,</div>
<div class="line">                <a class="code hl_variable" href="modules_2debug-tools_2log-system_2example_2main_8c.html#a475e5a31163799f852305a63d7530a8d">example_variable</a>);</div>
<div class="ttc" id="amodules_2debug-tools_2log-system_2example_2main_8c_html_a475e5a31163799f852305a63d7530a8d"><div class="ttname"><a href="modules_2debug-tools_2log-system_2example_2main_8c.html#a475e5a31163799f852305a63d7530a8d">example_variable</a></div><div class="ttdeci">uint8_t example_variable</div><div class="ttdoc">Example variable to be output to log_system.</div><div class="ttdef"><b>Definition:</b> <a href="modules_2debug-tools_2log-system_2example_2main_8c_source.html#l00051">main.c:51</a></div></div>
</div><!-- fragment --><p >Compile and flash the example application, and you should start seeing the log messages appear in CoolTerm, as shown below.</p>
<div class="image">
<img src="log_system_example_output.png" alt=""/>
<div class="caption">
Log System Example CoolTerm Output</div></div>
   <p >Insert logging function calls like this throughout your projects, and try to categorise them by output level. That way you can decide the level of detail required in your logs using the file_log_level variable for each file, and/or the <a class="el" href="debug-tools_2log-system_2example_2log__system_8c.html#a5e4303f4a037966d08b43a50444127ec" title="Sets maximum output level of logging required, has global effect.">log_set_global_max_output_level()</a> function. Once your application is ready to go, it can be useful to leave the log commands in the code, just use <a class="el" href="data-converters_2mcp48x2__dac_2example_2log__system_8c.html#ac584bce9d414acb531ee2650ab68bdfe" title="Turns logging system off globally.">log_global_off()</a> to turn off logging. That way if you (or another developer) find a bug later on, you can easily resume logging to find it.</p>
<p >Bear in mind however, that these log messages take quite some time to send, and your devices processor will hang while waiting for each USART frame to be sent, so don't use it in time critical sections of code, and absolutely don't use them inside an ISR. Instead, set a flag in the time sensitive section of code and then log that the flag has been set once the critical section has been left. You may even encounter bugs which disappear when logging is turned on, and reappear when it's turned off! That would potentially indicate a timing issue in your application.</p>
<p >For detailed debugging of timing issues in embedded software, an oscilloscope is invaluable. Set one or more GPIO pins to toggle on/off when certain sections of code (such as ISR's) are entered and exited, then hook those GPIO's up to your scope to capture a timing diagram. You can also determine from this exactly how long sections of code take to execute! </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
